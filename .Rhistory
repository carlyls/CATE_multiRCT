scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1a"),
c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1b"),
c(K=10, ns="same", cov_shift="no", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="same", cov_shift="yes", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1b"))
head(settings_ind)
i=1
#settings matrix with all the parameters that vary in each parallel run
settings_ind <- expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd),
cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1a"),
c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1b"),
c(K=10, ns="same", cov_shift="no", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="same", cov_shift="yes", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1b"))
settings <- do.call("rbind", replicate(1000, settings_ind, simplify = FALSE)) %>%
cbind(iteration = rep(1:1000, each=11))
i=1
iteration <- settings$iteration[i]
study_mean <- 0
study_inter_mean <- 0
K <- settings$K[i]
ns <- settings$ns[i]
cov_shift <- settings$cov_shift[i]
study_sd <- settings$study_sd[i]
study_inter_sd <- settings$study_inter_sd[i]
scenario <- settings$scenario[i]
seed <- i
honesty <- F
#settings matrix with all the parameters that vary in each parallel run
settings_ind <- expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd),
cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1a"),
c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1b"),
c(K=10, ns="same", cov_shift="no", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="same", cov_shift="yes", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1b"))
settings <- do.call("rbind", replicate(1000, settings_ind, simplify = FALSE)) %>%
cbind(iteration = rep(1:1000, each=11))
nrow(settings_ind)
#settings matrix with all the parameters that vary in each parallel run
settings_ind <- expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd),
cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1a"),
c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1b"),
c(K=10, ns="same", cov_shift="no", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="same", cov_shift="yes", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1b"))
settings <- do.call("rbind", replicate(1000, settings_ind, simplify = FALSE)) %>%
cbind(iteration = rep(1:1000, each=36))
nrow(settings)
i=1
iteration <- settings$iteration[i]
study_mean <- 0
study_inter_mean <- 0
K <- settings$K[i]
ns <- settings$ns[i]
cov_shift <- settings$cov_shift[i]
study_sd <- settings$study_sd[i]
study_inter_sd <- settings$study_inter_sd[i]
scenario <- settings$scenario[i]
seed <- i
honesty <- F
iteration
K
ns
cov_shift
mean(settings$K)
study_sd
settings_ind$K
settings_ind$K[1]
expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd),
cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2")))
expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd),
cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) -> a
summary(a$K)
expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd),
cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1a"))
expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd),
cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1a")) -> a
summary(a$K)
K
all_dat <- data.frame()
#change size per trial
if (ns == "same") { n_study <- rep(500, K) }
if (ns == "one large") { n_study <- c(1000, rep(200, K-1)) }
if (ns == "half and half") { n_study <- c(rep(500, K/2), rep(200, K/2)) }
ns
n_study
#study-specific coefficients
if (scenario %in% c("1a","1b")) {
study_main <- rnorm(K, mean=study_mean, sd=study_sd)
study_inter <- rnorm(K, mean=study_inter_mean, sd=study_inter_sd)
}
scenario
#settings matrix with all the parameters that vary in each parallel run
settings_ind <- expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sds="3,1", scenario="1a"),
c(K=10, ns="same", cov_shift="no", study_sds="3,1", scenario="1b"),
c(K=10, ns="same", cov_shift="no", study_sds="NA,NA", scenario="2"),
c(K=10, ns="same", cov_shift="yes", study_sds="0.5,0", scenario="1a"),
c(K=10, ns="one large", cov_shift="yes", study_sds="0.5,0", scenario="1a"),
c(K=10, ns="same", cov_shift="yes", study_sds="0.5,0", scenario="1b"),
c(K=10, ns="one large", cov_shift="yes", study_sds="0.5,0", scenario="1b"),
c(K=10, ns="same", cov_shift="yes", study_sds="NA,NA", scenario="2"),
c(K=20, ns="same", cov_shift="no", study_sds="0.5,0", scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sds="1,0.5", scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sds="0.5,0", scenario="1b"),
c(K=20, ns="same", cov_shift="no", study_sds="1,0.5", scenario="1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd),
cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
settings <- do.call("rbind", replicate(1000, settings_ind, simplify = FALSE)) %>%
cbind(iteration = rep(1:1000, each=36))
expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b"))
expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sds="3,1", scenario="1a"))
#settings matrix with all the parameters that vary in each parallel run
settings_ind <- expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd),
cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1a"),
c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1b"),
c(K=10, ns="same", cov_shift="no", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="same", cov_shift="yes", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1b"))
head(settings_ind)
#settings matrix with all the parameters that vary in each parallel run
settings_ind <- expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1a"),
c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1b"),
c(K=10, ns="same", cov_shift="no", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="same", cov_shift="yes", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1b")) %>%
mutate(K = as.numeric(K),
study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd))
settings_ind
settings_ind$K[1]
settings <- do.call("rbind", replicate(1000, settings_ind, simplify = FALSE)) %>%
cbind(iteration = rep(1:1000, each=36))
settings$K
settings$K %>% summary()
#settings matrix with all the parameters that vary in each parallel run
settings_ind <- expand.grid(K=c(10),
ns=c("same","one large","half and half"),
cov_shift=c("no"),
study_sds=c("0.5,0", "1,0", "1,0.5",
"1,1"),
scenario=c("1a","1b")) %>%
separate(study_sds, into=c("study_sd", "study_inter_sd"), sep=",") %>%
mutate(cov_shift = factor(cov_shift, levels=c("no","yes")),
scenario = factor(scenario, levels=c("1a","1b","2"))) %>%
rbind(c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1a"),
c(K=10, ns="same", cov_shift="no", study_sd=3, study_inter_sd=1, scenario="1b"),
c(K=10, ns="same", cov_shift="no", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=10, ns="same", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="one large", cov_shift="yes", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=10, ns="same", cov_shift="yes", study_sd=NA, study_inter_sd=NA, scenario="2"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1a"),
c(K=20, ns="same", cov_shift="no", study_sd=0.5, study_inter_sd=0, scenario="1b"),
c(K=20, ns="same", cov_shift="no", study_sd=1, study_inter_sd=0.5, scenario="1b")) %>%
mutate(K = as.numeric(K),
study_sd = as.numeric(study_sd),
study_inter_sd = as.numeric(study_inter_sd))
settings <- do.call("rbind", replicate(1000, settings_ind, simplify = FALSE)) %>%
cbind(iteration = rep(1:1000, each=36))
i
iteration <- settings$iteration[i]
study_mean <- 0
study_inter_mean <- 0
K <- settings$K[i]
ns <- settings$ns[i]
cov_shift <- settings$cov_shift[i]
study_sd <- settings$study_sd[i]
study_inter_sd <- settings$study_inter_sd[i]
scenario <- settings$scenario[i]
seed <- i
honesty <- F
all_dat <- data.frame()
#change size per trial
if (ns == "same") { n_study <- rep(500, K) }
if (ns == "one large") { n_study <- c(1000, rep(200, K-1)) }
if (ns == "half and half") { n_study <- c(rep(500, K/2), rep(200, K/2)) }
ns
n_study
#study-specific coefficients
if (scenario %in% c("1a","1b")) {
study_main <- rnorm(K, mean=study_mean, sd=study_sd)
study_inter <- rnorm(K, mean=study_inter_mean, sd=study_inter_sd)
}
scenario
study_main
study_inter
k=1
n <- n_study[k]
#sample covariates
Sigma <- diag(1, ncovar)
Sigma[1,3] <- Sigma[3,1] <- .5 #add correlation between two covariates
ncovar=5
#sample covariates
Sigma <- diag(1, ncovar)
Sigma[1,3] <- Sigma[3,1] <- .5 #add correlation between two covariates
n
Sigma
if (cov_shift == "no") {
dat <- MASS::mvrnorm(n=n, mu=rep(0,ncovar), Sigma=Sigma) %>% data.frame()
}
if (cov_shift == "yes") {
if (k %% 2 == 0) { dat <- MASS::mvrnorm(n=n, mu=rep(0,ncovar), Sigma=Sigma) %>% data.frame() }
else { dat <- MASS::mvrnorm(n=n, mu=c(2,rep(0,ncovar-1)), Sigma=Sigma) %>% data.frame() }
}
cov_shift
dat
#treatment
dat$W <- rbinom(n, size=1, prob=0.5)
#study and id
dat$S <- rep(k, n)
dat$id <- seq(1, n)
#noise
dat$eps <- rnorm(n, mean=0, sd=sd)
all_dat <- bind_rows(all_dat, dat)
sd
sd=.1
#noise
dat$eps <- rnorm(n, mean=0, sd=sd)
head(dat)
all_dat <- data.frame()
for (k in 1:K) {
n <- n_study[k]
#sample covariates
Sigma <- diag(1, ncovar)
Sigma[1,3] <- Sigma[3,1] <- .5 #add correlation between two covariates
if (cov_shift == "no") {
dat <- MASS::mvrnorm(n=n, mu=rep(0,ncovar), Sigma=Sigma) %>% data.frame()
}
if (cov_shift == "yes") {
if (k %% 2 == 0) { dat <- MASS::mvrnorm(n=n, mu=rep(0,ncovar), Sigma=Sigma) %>% data.frame() }
else { dat <- MASS::mvrnorm(n=n, mu=c(2,rep(0,ncovar-1)), Sigma=Sigma) %>% data.frame() }
}
#treatment
dat$W <- rbinom(n, size=1, prob=0.5)
#study and id
dat$S <- rep(k, n)
dat$id <- seq(1, n)
#noise
dat$eps <- rnorm(n, mean=0, sd=sd)
all_dat <- bind_rows(all_dat, dat)
}
nrow(all_dat)
head(all_dat)
#tau and Y
if (scenario == "1a") {
all_dat$m <- all_dat$X1/2 + all_dat$X2 + all_dat$X3 + all_dat$X4 +
study_main[all_dat$S] + study_inter[all_dat$S]*all_dat$X1
all_dat$tau <- all_dat$X1*(all_dat$X1>0) + study_main[all_dat$S] +
study_inter[all_dat$S]*all_dat$X1
}
if (scenario == "1b") {
all_dat$m <- 0
all_dat$tau <- (2/(1+exp(-12*(all_dat$X1-1/2))))*(2/(1+exp(-12*(all_dat$X2-1/2)))) +
study_main[all_dat$S] + study_inter[all_dat$S]*all_dat$X1
}
if (scenario == "2") {
all_dat$m <- all_dat$X1/2 + all_dat$X2 + all_dat$X3 + all_dat$X4
all_dat$tau <- ifelse(all_dat$S %in% c(1:4), (2/(1+exp(-12*(all_dat$X1-1/2))))*(2/(1+exp(-12*(all_dat$X2-1/2)))),
ifelse(all_dat$S %in% c(5:8), all_dat$X1*(all_dat$X1>0), 0))
}
all_dat$Y <- all_dat$m + (2*all_dat$W-1)/2*all_dat$tau + all_dat$eps
head(all_dat)
all_dat <- all_dat %>%
select(-eps,-m) %>%
mutate(S = factor(S)) %>%
relocate(S, id, W, X1, X2, X3, X4, X5, Y, tau)
head(all_dat)
#generate data
sim_dat <- gen_data(K, ns, cov_shift, study_mean, study_inter_mean,
study_sd, study_inter_sd, scenario)
gen_data <- function (K, ns, cov_shift, study_mean, study_inter_mean,
study_sd, study_inter_sd, scenario,
ncovar=5, sd=sqrt(0.01)) {
all_dat <- data.frame()
#change size per trial
if (ns == "same") { n_study <- rep(500, K) }
if (ns == "one large") { n_study <- c(1000, rep(200, K-1)) }
if (ns == "half and half") { n_study <- c(rep(500, K/2), rep(200, K/2)) }
#study-specific coefficients
if (scenario %in% c("1a","1b")) {
study_main <- rnorm(K, mean=study_mean, sd=study_sd)
study_inter <- rnorm(K, mean=study_inter_mean, sd=study_inter_sd)
}
for (k in 1:K) {
n <- n_study[k]
#sample covariates
Sigma <- diag(1, ncovar)
Sigma[1,3] <- Sigma[3,1] <- .5 #add correlation between two covariates
if (cov_shift == "no") {
dat <- MASS::mvrnorm(n=n, mu=rep(0,ncovar), Sigma=Sigma) %>% data.frame()
}
if (cov_shift == "yes") {
if (k %% 2 == 0) { dat <- MASS::mvrnorm(n=n, mu=rep(0,ncovar), Sigma=Sigma) %>% data.frame() }
else { dat <- MASS::mvrnorm(n=n, mu=c(2,rep(0,ncovar-1)), Sigma=Sigma) %>% data.frame() }
}
#treatment
dat$W <- rbinom(n, size=1, prob=0.5)
#study and id
dat$S <- rep(k, n)
dat$id <- seq(1, n)
#noise
dat$eps <- rnorm(n, mean=0, sd=sd)
all_dat <- bind_rows(all_dat, dat)
}
#tau and Y
if (scenario == "1a") {
all_dat$m <- all_dat$X1/2 + all_dat$X2 + all_dat$X3 + all_dat$X4 +
study_main[all_dat$S] + study_inter[all_dat$S]*all_dat$X1
all_dat$tau <- all_dat$X1*(all_dat$X1>0) + study_main[all_dat$S] +
study_inter[all_dat$S]*all_dat$X1
}
if (scenario == "1b") {
all_dat$m <- 0
all_dat$tau <- (2/(1+exp(-12*(all_dat$X1-1/2))))*(2/(1+exp(-12*(all_dat$X2-1/2)))) +
study_main[all_dat$S] + study_inter[all_dat$S]*all_dat$X1
}
if (scenario == "2") {
all_dat$m <- all_dat$X1/2 + all_dat$X2 + all_dat$X3 + all_dat$X4
all_dat$tau <- ifelse(all_dat$S %in% c(1:4), (2/(1+exp(-12*(all_dat$X1-1/2))))*(2/(1+exp(-12*(all_dat$X2-1/2)))),
ifelse(all_dat$S %in% c(5:8), all_dat$X1*(all_dat$X1>0), 0))
}
all_dat$Y <- all_dat$m + (2*all_dat$W-1)/2*all_dat$tau + all_dat$eps
all_dat <- all_dat %>%
select(-eps,-m) %>%
mutate(S = factor(S)) %>%
relocate(S, id, W, X1, X2, X3, X4, X5, Y, tau)
return(all_dat)
}
#generate data
sim_dat <- gen_data(K, ns, cov_shift, study_mean, study_inter_mean,
study_sd, study_inter_sd, scenario)
covars <- grep("^X", names(sim_dat), value=TRUE)
feat <- select(sim_dat, c(S,all_of(covars))) %>%
fastDummies::dummy_cols(select_columns="S", remove_selected_columns=T)
feat_nostudy <- select(sim_dat, all_of(covars))
covars
tr <- sim_dat$W
y <- sim_dat$Y
tau_true <- sim_dat$tau
#no study
tau_forest_nostudy <- causal_forest(X=feat_nostudy, Y=y, W=tr, num.threads=3, honesty=honesty, num.trees=1000)
tau_hat_nostudy <- c(tau_forest_nostudy$predictions)
causal_nostudy <- mean((tau_hat_nostudy - tau_true)^2)
causal_nostudy
#tan
causal_tan <- tan_preds(K, sim_dat, covars, "causalforest", honesty=honesty)
source("R/Comparing_methods_functions.R")
#tan
causal_tan <- tan_preds(K, sim_dat, covars, "causalforest", honesty=honesty)
causal_tan
causal_tan["mse_ss"]
source("R/Comparing_methods_functions.R")
#tan
causal_tan <- tan_preds(K, sim_dat, covars, "causalforest", honesty=honesty)
causal_tan
#study indicator
tau_forest <- causal_forest(X=feat, Y=y, W=tr, num.threads=3, honesty=honesty, num.trees=1000)
tau_hat <- c(tau_forest$predictions)
causal_studyind <- mean((tau_hat - tau_true)^2)
causal_studyind
